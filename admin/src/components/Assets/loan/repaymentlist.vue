<template>    <div>        <el-row>            <!--<div class="fl m-b-10">-->                <!--<el-button type="primary" @click="$router.push('/loan/loan/search')" icon="el-icon-search">查询放款记录-->                <!--</el-button>-->                <!--<el-button type="primary" @click="$router.push('/loan/loan/edit/add')" icon="el-icon-plus">添加记录-->                <!--</el-button>-->            <!--</div>-->        </el-row>        <el-card shadow="never" style="margin-bottom: 30px;">            <el-form :inline="true" :model="condition" class="demo-form-inline delbtm">                <el-input v-model="condition.keywords" class="w-230 m-r-15" placeholder="请输入姓名/手机/身份证/芝麻分"></el-input>                <el-select v-model="condition.loan_account" class="w-200 m-r-15" placeholder="请选择放款方式" clearable>                    <el-option value="0" label="全部"></el-option>                    <el-option :value="item.id" :label="item.name" v-for="(item,index) in loanAccount"></el-option>                </el-select>                <el-date-picker class="w-300 m-r-15" v-model="condition.begin_time" type="daterange" align="right"                                value-format="yyyy-MM-dd HH:mm:ss"                                unlink-panels range-separator="至" start-placeholder="借款开始日期" end-placeholder="借款结束日期">                </el-date-picker>                <span v-if="post_id !== 2">                    <el-select v-model="condition.structure_id" filterable placeholder="请选择组" class="w-150 m-r-15"                               clearable>                        <el-option value="0" label="全部"></el-option>                        <el-option v-for="item in groupList.list" :key="item.id" :label="item.name" :value="item.id">                        </el-option>                    </el-select>                    <el-select v-model="condition.uid" filterable placeholder="请选择组员" class="w-150 m-r-15" clearable>                        <el-option value="0" label="全部"></el-option>                        <el-option v-for="item in groupMemberList.list" :key="item.id" :label="item.realname"                                   :value="item.id">                        </el-option>                    </el-select>                </span>                <!--<el-date-picker class="w-300" v-model="condition.end_time" type="daterange" align="right" value-format="yyyy-MM-dd HH:mm:ss"-->                <!--unlink-panels range-separator="至" start-placeholder="还款开始日期" end-placeholder="还款结束日期">-->                <!--</el-date-picker>-->                <!--<el-form-item class="w-300">-->                <!--<el-col :span="11">-->                <!--<el-input v-model="condition.total_amount[0]" placeholder="应还金额"></el-input>-->                <!--</el-col>-->                <!--<el-col class="line" style="text-align: center;" :span="2">到</el-col>-->                <!--<el-col :span="11">-->                <!--<el-input v-model="condition.total_amount[1]" placeholder="应还金额"></el-input>-->                <!--</el-col>-->                <!--</el-form-item>-->                <!-- <el-input v-model="condition.loanCount" class="w-150 m-r-10" placeholder="请输入借款次数"></el-input> -->                <el-button icon="el-icon-search" @click="getData(activeTab)" type="primary">查询</el-button>                <el-button icon="icon iconfont iconset icon-daochu" @click="exportExcel(activeTab)" type="primary">导出</el-button>                <!--<el-row class="m-t-10" v-if="post_id !== 2">-->                <!--</el-row>-->            </el-form>        </el-card>        <el-card class="box-card" shadow="never" style="border: none;">            <el-row>                <el-col>                    <el-row>                        <el-tabs v-model="activeTab" @tab-click="changeTab">                            <el-tab-pane :label="item.label" :name="item.index" v-for="(item,index) of labelName">                                <el-table :data="structureData[item.index].list" stripe style="width: 100%"                                          :default-sort="{prop: 'date', order: 'descending'}">                                    <el-table-column prop="name" label="借款人" sortable align="center">                                    </el-table-column>                                    <el-table-column prop="phone" label="手机" :formatter="formatter" width="120"                                                     align="center">                                    </el-table-column>                                    <el-table-column prop="age" label="年龄" :formatter="formatter" align="center">                                    </el-table-column>                                    <el-table-column prop="zhima" label="芝麻分" sortable :formatter="formatter"                                                     align="center">                                    </el-table-column>                                    <el-table-column prop="begin_time" label="借款日期" sortable :formatter="formatter"                                                     width="180" align="center">                                    </el-table-column>                                    <el-table-column prop="end_time" label="约定还款日期" sortable :formatter="formatter"                                                     width="180" align="center">                                    </el-table-column>                                    <el-table-column prop="loan_cycle" label="借款时间" sortable :formatter="formatter"                                                     align="center">                                    </el-table-column>                                    <el-table-column prop="loan_account_txt" label="借款方式" sortable                                                     :formatter="formatter" width="150" align="center">                                    </el-table-column>                                    <el-table-column prop="loan_amount" label="借款金额" sortable :formatter="formatter"                                                     align="center">                                        <template slot-scope="scope">                                            {{ scope.row.loan_amount?parseInt(scope.row.loan_amount).toFixed(2):0 }}                                        </template>                                    </el-table-column>                                    <el-table-column prop="total_amount" label="应还金额" sortable :formatter="formatter"                                                     align="center">                                        <template slot-scope="scope">                                            {{ scope.row.total_amount?parseInt(scope.row.total_amount).toFixed(2):0 }}                                        </template>                                    </el-table-column>                                    <el-table-column prop="username" label="录入人" sortable :formatter="formatter"                                                     align="center">                                    </el-table-column>                                    <el-table-column prop="status_txt" label="状态" sortable :formatter="formatter"                                                     width="110">                                    </el-table-column>                                    <el-table-column label="操作" align="center">                                        <template slot-scope="scope">                                            <div v-if="scope.row.status_txt === '履约还款' || scope.row.status_txt === '分期已还清' || scope.row.status_txt === '逾期后还款'">                                                <el-dropdown trigger="click">                                                    <el-button type="primary" size="mini">                                                        操作                                                        <i class="el-icon-arrow-down el-icon--right"></i>                                                    </el-button>                                                    <el-dropdown-menu slot="dropdown">                                                        <el-dropdown-item @click.native="goEditPage(scope.row)">编辑                                                        </el-dropdown-item>                                                        <el-dropdown-item                                                                @click.native="moreAction(scope.row,'history')">还款历史                                                        </el-dropdown-item>                                                        <el-dropdown-item @click.native="moreAction(scope.row,'renew')">                                                            续借                                                        </el-dropdown-item>                                                    </el-dropdown-menu>                                                </el-dropdown>                                            </div>                                            <div v-else>                                                <el-dropdown trigger="click">                                                    <el-button type="primary" size="mini">                                                        操作                                                        <i class="el-icon-arrow-down el-icon--right"></i>                                                    </el-button>                                                    <el-dropdown-menu slot="dropdown">                                                        <el-dropdown-item @click.native="goEditPage(scope.row)">编辑                                                        </el-dropdown-item>                                                        <el-dropdown-item                                                                @click.native="moreAction(scope.row,'history')">还款历史                                                        </el-dropdown-item>                                                        <el-dropdown-item                                                                @click.native="moreAction(scope.row,'repayment')">还款                                                        </el-dropdown-item>                                                        <el-dropdown-item                                                                @click.native="moreAction(scope.row,'extension')">延期                                                        </el-dropdown-item>                                                        <!-- <el-dropdown-item @click.native="moreAction(scope.row,'renew')">续借</el-dropdown-item> -->                                                    </el-dropdown-menu>                                                </el-dropdown>                                            </div>                                        </template>                                    </el-table-column>                                </el-table>                                <el-pagination layout="total,prev, pager, next" class="fr"                                               :total="structureData[item.index].dataCount" :pageSize="15"                                               @current-change="getDataByPage">                                </el-pagination>                            </el-tab-pane>                        </el-tabs>                    </el-row>                </el-col>            </el-row>        </el-card>        <el-dialog title="还款历史" :visible.sync="isShowDialog.history" @close="activeAction.actionName=''">            <el-table :data="loanHistory.list" border style="width: 100%">                <el-table-column prop="total_amount" label="还款总额" width="120" align="center">                </el-table-column>                <el-table-column prop="repayment_amount" label="此次还款" width="120" align="center">                </el-table-column>                <el-table-column prop="balance_amount" label="剩余应还" width="120" align="center">                </el-table-column>                <el-table-column prop="is_installment" label="是否分期" width="80" align="center">                    <template slot-scope="scope">                        {{scope.row.is_installment === 1?'是':'否'}}                    </template>                </el-table-column>                <el-table-column prop="is_collection" label="是否催收还款" width="120" align="center">                    <template slot-scope="scope">                        {{scope.row.is_collection === 1?'是':'否'}}                    </template>                </el-table-column>                <el-table-column prop="create_time" label="创建时间" width="200" align="center">                </el-table-column>                <el-table-column label="状态" align="center">                    <template slot-scope="scope">                        {{scope.row.status === 1?'正常':'撤销'}}                    </template>                </el-table-column>            </el-table>            <el-pagination layout="total,prev, pager, next" class="fr" :total="loanHistory.dataCount" :pageSize="15"                           @current-change="getDataByPage">            </el-pagination>            <div slot="footer"></div>        </el-dialog>        <el-dialog title="还款操作" :visible.sync="isShowDialog.repayment" width="30%" @close="activeAction.actionName=''">            <el-form label-width="130px">                <el-form-item label="还款状态">                    <el-select v-model="repayment.status" class="w-200">                        <el-option :value="item.value" :label="item.title"                                   v-for="(item,index) in repayment.data.status"></el-option>                    </el-select>                </el-form-item>                <el-form-item label="本次还款金额">                    <el-input v-model="repayment.amount" placeholder="请输入本次还款金额" class="w-200"></el-input>                </el-form-item>                <el-form-item label="是否催收还款">                    <el-radio v-model="repayment.is_collection" :label="item.value"                              v-for="(item,index) in repayment.data.is_collection">{{item.title}}                    </el-radio>                </el-form-item>            </el-form>            <div slot="footer" class="dialog-footer">                <el-button @click="isShowDialog.repayment = false">取 消</el-button>                <el-button type="primary" @click="submitRepayment(0)">确 定</el-button>            </div>        </el-dialog>        <el-dialog title="延期" :visible.sync="isShowDialog.extension" @close="activeAction.actionName=''" width="30%">            <el-form label-width="130px">                <el-form-item label="延期天数">                    <el-input v-model="extension.delay_day" placeholder="请输入延期天数" class="w-200"></el-input>                </el-form-item>                <el-form-item label="延期费">                    <el-input v-model="extension.delay_amount" placeholder="请输入延期费" class="w-200"></el-input>                </el-form-item>            </el-form>            <div slot="footer" class="dialog-footer">                <el-button @click="isShowDialog.extension = false">取 消</el-button>                <el-button type="primary" @click="submitExtension">确 定</el-button>            </div>        </el-dialog>        <renew :isShow="isShowDialog.renew" :basic="renew.basic"></renew>        <!-- <el-dialog title="续借" :visible.sync="isShowDialog.renew" @close="activeAction.actionName=''"></el-dialog> -->    </div></template><script>  import http from '../../../assets/js/http'  import renew from './renew.vue'  export default {    data () {      return {        activeCaseId: '',        activeTab: '4',        activeAction: {id: '', actionName: '', info: ''},        labelName: [          {index: '4', label: '履约还款'},          {index: '5', label: '逾期后还款'},          {index: '6', label: '分期还款中'},          {index: '7', label: '分期已还清'},        ],// 控制标签页顺序        structureData: {          '4': {            dataCount: 0,            list: [],          },          '5': {            dataCount: 0,            list: [],          },          '6': {            dataCount: 0,            list: [],          },          '7': {            dataCount: 0,            list: [],          },        },// 控制标签页内容        loanAccount: [],        post_id: JSON.parse(localStorage.getItem('userInfo')).data.post_id,        condition: {          keywords: '',          page: 1,          limit: 15,          loan_account: '',          begin_time: [],          end_time: [],          total_amount: [],          structure_id: '',          uid: '',        },        groupList: {},        groupMemberList: {},        repayment: {          status: '',          amount: '',          is_collection: 0,          force: 0,          data: {            status: [              {value: 2, title: '全部还款'},              {value: 3, title: '逾期还款'},              {value: 4, title: '分期还款中（部分还）'},              {value: 5, title: '分期已还清'}],            is_collection: [{value: 0, title: '不是'}, {value: 1, title: '是'}],          },        },        loanHistory: {},        extension: {          delay_day: '',          delay_amount: '',        },        renew: {          basic: {},        },        isShowDialog: {          history: false,          repayment: false,          extension: false,          renew: false,        },      }    },    watch: {      'activeAction.actionName': function (val, old) { // 控制不同功能下触发的动作        if (val === 'history') {          this.getActiveLoanHistory()        }        if (val === 'renew') {          this.reNewLoan()        }        if (old === 'repayment') {//关闭还款弹窗后清除选择的数据          this.$set(this.repayment, 'amount', '')          this.$set(this.repayment, 'status', '')        }      },      'isShowDialog.renew': function (val, old) {//续借的弹窗开启又关闭（新增一条记录后  重新请求数据        if (old === true && val === false) {          this.getData()        }      },      'condition.structure_id': function () {        this.getGroupMember()      },      'repayment.status': function (val) {        if (val === 2) {//当全部还款时自动填入还款金额          this.$set(this.repayment, 'amount', this.activeAction.info.total_amount)        }      },    },    computed: {      queryParams () { //用于查询和请求的值        let tmp = {type: this.activeTab, ...this.condition}        return {params: tmp}      },    },    mounted () {      this.getData()      this.getLoanAccount()      if (this.post_id !== 2) {        this.getGroup()      }    },    methods: {      getData (type = this.activeTab) {        this.apiGet('/admin/loan', this.queryParams).then((res) => {          _g.closeGlobalLoading()          if (res.code === 200) {            this.$set(this.structureData, type, res.data)          } else {            this.$message.error(res.error)          }        }).catch((err) => {          this.$message.error(err)        })      },      exportExcel () {        this.apiPostForExport('/admin/loan/index', {...this.queryParams.params, do_excel: 1}).then((res) => {          let blob = new Blob([res.data], {type: 'application/vnd.ms-excel'})          let objectUrl = URL.createObjectURL(blob)          window.location.href = objectUrl          _g.toastMsg('success', '导出成功')        }).catch((err) => {          this.$message.error(err)        })      },      getLoanAccount () {        this.apiGet('/admin/getLoanAccount').then((res) => {          if (res.code === 200) {            this.$set(this, 'loanAccount', res.data.list)          } else {            this.$message.error(res.error)          }        }).catch((err) => {          this.$message.error(err)        })      },      moreAction (row, actionName) {        this.activeAction.id = row.id        this.activeAction.actionName = actionName        this.activeAction.info = row        if (actionName !== 'renew') { // 续借的弹窗开启在接口请求成功后进行          this.isShowDialog[actionName] = true        }      },      goEditPage (row) {        this.$router.push(`/loan/loan/edit/edit?id=${row.id}`)      },      getDataByPage (page) {        this.$set(this.condition, 'page', page)        this.getData()      },      selectLoanType (command) { // 选择借款方式        this.$set(this.condition, 'loanAccount', command.id)      },      changeTab (tab) { // 修改标签页        if (!this.structureData[tab.name].dataCount) { // 如果对应的数据为空则请求 否则不请求 只是切换标签页          this.getData()        }      },      getGroup () { //获取组        this.apiGet('/admin/Structures/getGroup').then((res) => {          if (res.code === 200) {            this.$set(this, 'groupList', res.data)          } else {            _g.toastMsg('error', res.error)          }        }).catch((err) => {          _g.toastMsg('error', err)        })      },      getGroupMember () {// 获取组成员        this.apiGet('/admin/users', {params: {structure_id: this.condition.structure_id}}).then((res) => {          if (res.code === 200) {            this.$set(this, 'groupMemberList', res.data)          } else {            _g.toastMsg('error', res.error)          }        }).catch((err) => {          _g.toastMsg('error', err)        })      },      submitRepayment (force) {// 提交还款操作        let form = {...this.repayment}        form.force = force        form.id = this.activeAction.id //当前选中的条目ID        delete form.data        this.apiPost('/admin/loan/opreation', form).then((res) => {          if (res.code === 200) {            this.$message.success(res.data)            this.isShowDialog.repayment = false            this.getData()          } else if (res.code === 201) {            this.$confirm(`${res.error}`, '提示', {              confirmButtonText: '确定',              cancelButtonText: '取消',              type: 'warning',            }).then(() => {              this.submitRepayment(1)              this.getData()            }).catch(() => {              this.isShowDialog.repayment = false            })          } else {            this.$message.error(res.error)          }        }).catch((err) => {          this.$message.error(err)        })      },      getActiveLoanHistory () { // 获取置顶条目的历史        this.apiGet('/admin/getLoanRepaymentHistoryList', {params: {loan_id: this.activeAction.id}}).then((res) => {          if (res.code === 200) {            this.$set(this, 'loanHistory', res.data)          } else {            this.$message.error(res.error)          }        }).catch((err) => {          this.$message.error(err)        })      },      submitExtension () { // 提交延期操作        this.apiPost('/admin/loan/delayLoan', {id: this.activeAction.id, ...this.extension}).then((res) => {          this.isShowDialog.extension = false          if (res.code === 200) {            this.$message.success(res.data)            this.getData()          } else {            this.$message.error(res.error)          }        }).catch((err) => {          this.$message.error(err)        })      },      reNewLoan () {  // 续借操作        // this.$confirm('如果上一个订单未逾期将会自动正常还款，否则标记为逾期还款或者分期已还清并生产还款记录?', '提示', {        //     confirmButtonText: '确定',        //     cancelButtonText: '取消',        //     type: 'warning'        // }).then(() => {        this.apiPost('/admin/loan/redecorateLoan', {id: this.activeAction.id}).then((res) => {          this.$set(this.activeAction, 'id', '')          if (res.code === 200) {            this.isShowDialog.renew = true            this.$set(this.renew, 'basic', res.data)          } else {            this.$message.error(res.error)            this.activeAction.actionName = ''//控制父组件          }        }).catch((err) => {          this.$message.error(err)        })      },    },    created () {    },    components: {      renew,    },    mixins: [http],  }</script><style lang="less" scoped>    .maskColor {        display: inline-block;        width: 6px;        height: 18px;    }    .delbtm .el-form-item {        margin-bottom: 0;    }</style>